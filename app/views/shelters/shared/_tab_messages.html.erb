<!-- app/views/shelters/shared/_tab_messages.html.erb -->

<div class="space-y-6">
  <!-- New conversation -->
  <div class="bg-white rounded-2xl shadow-sm p-6">
    <h2 class="text-lg font-semibold text-slate-900 mb-2">
      Start a new conversation
    </h2>
    <p class="text-xs text-slate-500 mb-4">
      Send a message from <%= @shelter.name %> to another shelter.
    </p>

    <% if @conversation_targets.any? %>
      <%= form_with url: conversations_path, scope: :conversation do |f| %>
        <%= f.hidden_field :from_shelter_id, value: @shelter.id %>

        <div class="space-y-3">
          <div>
            <%= f.label :to_shelter_id, "To shelter", class: "block text-sm font-medium text-slate-700" %>
            <%= f.select :to_shelter_id,
                         options_from_collection_for_select(@conversation_targets, :id, :name),
                         { prompt: "Select a shelter" },
                         class: "mt-1 block w-full rounded-lg border border-slate-300 px-3 py-2 text-sm" %>
          </div>

          <div>
            <%= f.label :subject, class: "block text-sm font-medium text-slate-700" %>
            <%= f.text_field :subject,
                             class: "mt-1 block w-full rounded-lg border border-slate-300 px-3 py-2 text-sm" %>
          </div>

          <div>
            <%= f.label :body, "Message", class: "block text-sm font-medium text-slate-700" %>
            <%= f.text_area :body,
                            rows: 3,
                            class: "mt-1 block w-full rounded-lg border border-slate-300 px-3 py-2 text-sm" %>
          </div>

          <div class="pt-2">
            <%= f.submit "Send message", class: "btn-primary rounded-xl" %>
          </div>
        </div>
      <% end %>
    <% else %>
      <p class="text-sm text-slate-500">
        There are no other shelters yet to message.
      </p>
    <% end %>
  </div>

  <!-- Conversation list + current thread -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Left: conversation list -->
    <div class="bg-white rounded-2xl shadow-sm p-4 lg:col-span-1">
      <h3 class="text-sm font-semibold text-slate-900 mb-3">Conversations</h3>

      <% if @conversations.any? %>
        <ul class="space-y-2 text-sm">
          <% @conversations.each do |conv| %>
            <% active = (@current_conversation && conv.id == @current_conversation.id) %>
            <% other_shelter =
                conv.from_shelter_id == @shelter.id ? conv.to_shelter : conv.from_shelter %>

            <li>
              <%= link_to shelter_path(@shelter, tab: "messages", conversation_id: conv.id),
                          class: [
                            "block rounded-xl px-3 py-2 transition",
                            (active ? "bg-slate-900 text-white" : "hover:bg-slate-100 text-slate-800")
                          ].join(" ") do %>
                <div class="flex items-start gap-2">
                  <div class="flex-1 min-w-0">
                    <div class="font-medium truncate">
                      <%= conv.subject %>
                    </div>
                    <div class="text-xs opacity-80 truncate">
                      With <%= other_shelter.name %>
                    </div>
                  </div>

                  <% if conv.last_message_at.present? %>
                    <span class="text-[11px] opacity-70 shrink-0 self-center">
                      <%= l conv.last_message_at, format: :short %>
                    </span>
                  <% end %>
                </div>
              <% end %>
            </li>
          <% end %>

        </ul>
      <% else %>
        <p class="text-sm text-slate-500">
          No conversations yet.
        </p>
      <% end %>
    </div>

    <!-- Right: current thread -->
    <div class="bg-white rounded-2xl shadow-sm p-6 lg:col-span-2">
      <% if @current_conversation %>
        <% conv = @current_conversation %>
        <% other_shelter =
             conv.from_shelter_id == @shelter.id ? conv.to_shelter : conv.from_shelter %>

        <header class="mb-4 flex items-start justify-between">
          <div>
            <h3 class="text-base font-semibold text-slate-900"><%= conv.subject %></h3>
            <p class="text-xs text-slate-500">
              Between <%= conv.from_shelter.name %> and <%= conv.to_shelter.name %>
            </p>
          </div>

          <%= button_to "Delete",
                conversation_path(conv),
                method: :delete,
                form: { data: { turbo_confirm: "Delete this entire conversation?" }},
                class: "pill-base pill-clickable pill-danger ml-4" %>
        </header>


        <div class="space-y-3 mb-4 max-h-80 overflow-y-auto pr-1">
          <% conv.messages.order(created_at: :asc).each do |msg| %>
            <div class="border border-slate-100 rounded-xl px-3 py-2 text-sm">
              <div class="flex justify-between items-center mb-1">
                <span class="font-medium text-slate-800">
                  <%= msg.user&.email || "System" %>
                </span>
                <span class="text-[11px] text-slate-500">
                  <%= l msg.created_at, format: :short %>
                </span>
              </div>
              <div class="text-slate-800 whitespace-pre-line">
                <%= msg.body %>
              </div>
            </div>
          <% end %>
        </div>

        <!-- Reply box -->
        <div class="border-t border-slate-100 pt-4">
          <%= form_with model: [@current_conversation, Message.new] do |f| %>
            <div class="space-y-2">
              <%= f.label :body, "Reply", class: "block text-sm font-medium text-slate-700" %>
              <%= f.text_area :body,
                              rows: 3,
                              class: "mt-1 block w-full rounded-lg border border-slate-300 px-3 py-2 text-sm" %>
              <div class="pt-1">
                <%= f.submit "Send reply", class: "btn-primary rounded-xl" %>
              </div>
            </div>
          <% end %>
        </div>
      <% else %>
        <p class="text-sm text-slate-500">
          Select a conversation on the left, or start a new one above.
        </p>
      <% end %>
    </div>
  </div>
</div>
